## Use of AI Acknowledgement

**Student ID**: 1155191923

**Project Phase**: 2B & 3

**Date**: 9 Mar, 2025

## Acknowledgement

I acknowledge the use of [Copilot] as a reference towards the completion of the project.

### Transcript

**Prompt**:
how can I name the image file with the pid in the mysql database?

### Response

# Image File Naming with Database PID

The issue is that you're trying to use `req.body.pid` to name the file before the database has generated this value. Since the product ID is auto-generated by MySQL, you need to save the product first, then handle the image upload with the new ID.

Here's how to modify your code:

1. First, import path which is missing:

```javascript
import express from "express";
import cors from "cors";
import mysql from "mysql2";
import multer from "multer";
import path from "path"; // Add this import
```

2. Fix the typo in your database connection:

```javascript
const db = mysql.createConnection({
  host: "localhost", // Fixed typo: localhostt â†’ localhost
  port: "3306",
  user: "shop27-admin",
  password: "mypass",
  database: "shop27",
});
```

3. Modify your approach to handle the image file naming:

```javascript
// First, create a storage without specific filename logic for temporary storage
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, "uploads/");
  },
  filename: function (req, file, cb) {
    // Use a timestamp to create unique temporary filenames
    cb(null, `temp_${Date.now()}${path.extname(file.originalname)}`);
  },
});

// Then modify your route handler
app.post("/admin/add-product", upload.single("image"), async (req, res) => {
  try {
    const { catid, name, price, description } = req.body;
    const tempFilePath = req.file ? req.file.path : null;

    // Insert the product first to get the ID
    const sql =
      "INSERT INTO products (catid, name, price, description) VALUES (?, ?, ?, ?)";
    const [result] = await db
      .promise()
      .query(sql, [catid, name, price, description]);

    const newProductId = result.insertId;
    let finalImagePath = null;

    // If there was an image uploaded, rename it with the new product ID
    if (tempFilePath) {
      const fileExt = path.extname(req.file.originalname);
      const newFileName = `${newProductId}${fileExt}`;
      const newFilePath = `uploads/${newFileName}`;

      // Rename the file
      fs.renameSync(tempFilePath, newFilePath);
      finalImagePath = newFilePath;

      // Update the product record with the image path
      await db
        .promise()
        .query("UPDATE products SET image = ? WHERE pid = ?", [
          finalImagePath,
          newProductId,
        ]);
    }

    res.status(200).send({
      message: "Product added successfully!",
      productId: newProductId,
    });
  } catch (error) {
    console.error(error);
    res.status(400).send(error);
  }
});
```

4. Don't forget to add the fs module import at the top:

```javascript
import fs from "fs";
```

This solution:

1. Creates a temporary unique filename for initial upload
2. Inserts the product to get the database-generated ID
3. Renames the file using the new ID
4. Updates the product record with the final file path

**Prompt**:
failed to fetch: fetchProductDetails @ index.js:121 await in fetchProductDetails addItem @ index.js:147 (anonymous) @ index.js:92Understand this errorAI
Please help me debug

### Response

# Fix for "Failed to fetch" Error in Shopping Cart

The error is occurring in your `fetchProductDetails` method. There are several issues:

## 1. Product Data Structure Mismatch

Your server returns an array of products, but your code tries to access properties directly from this array:

```javascript
const product = await response.json();
const item = this.items.get(pid);
item.name = product.name; // ERROR: product is an array, not an object
item.price = product.price;
```

## 2. Incorrect Item Structure in loadFromStorage

You're storing items incorrectly:

```javascript
this.items.set(item.pid, { item }); // Creates nested structure { item: { pid, name, etc } }
```

## Fixed Code:

```javascript
async fetchProductDetails(pid) {
  try {
    const response = await fetch(`${API}/api/product/${pid}`);
    if (!response.ok) throw new Error("Product not found");

    const data = await response.json();

    // Get the first product from array
    if (!data || !data[0]) {
      throw new Error("Invalid product data");
    }

    const product = data[0];  // Access the first element in the array
    const item = this.items.get(pid);

    if (item) {
      // Update item properties
      item.name = product.name;
      item.price = parseFloat(product.price); // Ensure price is a number
      this.updateUI();
      this.saveToStorage();
    }
  } catch (error) {
    console.error("Failed to fetch:", error);
    this.items.delete(pid);
    alert(`Failed to load product details: ${error.message}`);
  }
}

loadFromStorage() {
  const saved = localStorage.getItem("shopping-cart");
  if (!saved) return;

  try {
    const data = JSON.parse(saved);
    data.forEach((item) => {
      // Store properties directly, not nested in an item object
      this.items.set(item.pid, {
        quantity: item.quantity || 1,
        price: parseFloat(item.price) || 0,
        name: item.name || ""
      });

      // Only fetch if we don't have name or price
      if (!item.name || !item.price) {
        this.fetchProductDetails(item.pid);
      }
    });
  } catch (error) {
    console.error("Error loading cart:", error);
    localStorage.removeItem("shopping-cart");
  }
}
```

## 3. Fix updateUI Method

You also need to fix your updateUI method, which is trying to access a selector that doesn't exist:

```javascript
updateUI() {
  const container = document.getElementById("cart-item"); // Changed from "cart-items"
  if (!container) {
    console.error("Cart container not found");
    return;
  }

  container.innerHTML = "";
  let total = 0;

  if (this.items.size === 0) {
    container.innerHTML = "<li>Your cart is empty</li>";
    document.getElementById("total-amount").textContent = "0.00";
    return;
  }

  this.items.forEach((item, pid) => {
    // Debug logging
    console.log("Rendering item:", pid, item);

    if (!item.name) {
      console.log("Item missing name, fetching details:", pid);
      this.fetchProductDetails(pid);
      return;
    }

    // Create cart item
    const li = document.createElement("li");
    li.className = "cart-item";
    li.dataset.pid = pid;

    li.innerHTML = `
      <span class="item-name">${item.name}</span>
      <div class="quantity-controls">
        <button class="decrement">-</button>
        <input type="number" class="quantity" min="1" value="${item.quantity}">
        <button class="increment">+</button>
      </div>
      <span class="item-price">$${(item.price * item.quantity).toFixed(2)}</span>
    `;

    total += item.price * item.quantity;
    container.appendChild(li);
  });

  document.getElementById("total-amount").textContent = total.toFixed(2);
}
```

These changes should fix the fetch error and ensure your shopping cart works correctly.
