## Use of AI Acknowledgement

**Student ID**: 1155191923

**Project Phase**: 2B & 3

**Date**: 9 Mar, 2025

## Acknowledgement

I acknowledge the use of [Copilot] as a reference towards the completion of the project.

### Transcript

**Prompt**:
how can I name the image file with the pid in the mysql database?

### Response

# Image File Naming with Database PID

The issue is that you're trying to use `req.body.pid` to name the file before the database has generated this value. Since the product ID is auto-generated by MySQL, you need to save the product first, then handle the image upload with the new ID.

Here's how to modify your code:

1. First, import path which is missing:

```javascript
import express from "express";
import cors from "cors";
import mysql from "mysql2";
import multer from "multer";
import path from "path"; // Add this import
```

2. Fix the typo in your database connection:

```javascript
const db = mysql.createConnection({
  host: "localhost", // Fixed typo: localhostt â†’ localhost
  port: "3306",
  user: "shop27-admin",
  password: "mypass",
  database: "shop27",
});
```

3. Modify your approach to handle the image file naming:

```javascript
// First, create a storage without specific filename logic for temporary storage
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, "uploads/");
  },
  filename: function (req, file, cb) {
    // Use a timestamp to create unique temporary filenames
    cb(null, `temp_${Date.now()}${path.extname(file.originalname)}`);
  },
});

// Then modify your route handler
app.post("/admin/add-product", upload.single("image"), async (req, res) => {
  try {
    const { catid, name, price, description } = req.body;
    const tempFilePath = req.file ? req.file.path : null;

    // Insert the product first to get the ID
    const sql =
      "INSERT INTO products (catid, name, price, description) VALUES (?, ?, ?, ?)";
    const [result] = await db
      .promise()
      .query(sql, [catid, name, price, description]);

    const newProductId = result.insertId;
    let finalImagePath = null;

    // If there was an image uploaded, rename it with the new product ID
    if (tempFilePath) {
      const fileExt = path.extname(req.file.originalname);
      const newFileName = `${newProductId}${fileExt}`;
      const newFilePath = `uploads/${newFileName}`;

      // Rename the file
      fs.renameSync(tempFilePath, newFilePath);
      finalImagePath = newFilePath;

      // Update the product record with the image path
      await db
        .promise()
        .query("UPDATE products SET image = ? WHERE pid = ?", [
          finalImagePath,
          newProductId,
        ]);
    }

    res.status(200).send({
      message: "Product added successfully!",
      productId: newProductId,
    });
  } catch (error) {
    console.error(error);
    res.status(400).send(error);
  }
});
```

4. Don't forget to add the fs module import at the top:

```javascript
import fs from "fs";
```

This solution:

1. Creates a temporary unique filename for initial upload
2. Inserts the product to get the database-generated ID
3. Renames the file using the new ID
4. Updates the product record with the final file path
